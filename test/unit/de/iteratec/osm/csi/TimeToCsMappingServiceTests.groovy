/* 
* OpenSpeedMonitor (OSM)
* Copyright 2014 iteratec GmbH
* 
* Licensed under the Apache License, Version 2.0 (the "License"); 
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
* 
* 	http://www.apache.org/licenses/LICENSE-2.0
* 
* Unless required by applicable law or agreed to in writing, software 
* distributed under the License is distributed on an "AS IS" BASIS, 
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. 
* See the License for the specific language governing permissions and 
* limitations under the License.
*/

package de.iteratec.osm.csi

import static org.hamcrest.Matchers.*
import static org.junit.Assert.*
import grails.test.mixin.*

import org.junit.*
import de.iteratec.osm.util.ServiceMocker

/**
 * See the API for {@link grails.test.mixin.domain.DomainClassUnitTestMixin} for usage instructions
 */
@TestFor(TimeToCsMappingService)
@Mock([Page])
class TimeToCsMappingServiceTests {
	
	TimeToCsMappingService serviceUnderTest
	ServiceMocker mocker
	Page page
	Map<String, Double> mappings
	List<Double> hpFrustrations
	def fvDocAndCsFromExcel
	
	@Test
	void testGetCustomerSatisfactionInPercentViaMapping() {
		
		//test specific mocks
		mocker.mockTimeToCsMappingService(serviceUnderTest, mappings, hpFrustrations)
		
		fvDocAndCsFromExcel.each{
			Double csCalculated = serviceUnderTest.getCustomerSatisfactionInPercentViaMapping(it[0], page)
			Double difference = Math.abs(csCalculated - it[1])
			assert difference < 0.003
		}
		
	}
	
	@Test
	void testGetCustomerSatisfactionPercentRank(){
		
		//test specific mocks
		mocker.mockTimeToCsMappingService(serviceUnderTest, mappings, hpFrustrations)
		
		fvDocAndCsFromExcel.each{
			Double csCalculated = serviceUnderTest.getCustomerSatisfactionPercentRank(it[0], page)
			Double difference = Math.abs(csCalculated - it[1])
			assert difference < 0.002
		}
		
	}
	
	@Test
	void testValidFrustrationsExistFor(){

		//with valid frustrations for page
		mocker.mockTimeToCsMappingService(serviceUnderTest, mappings, hpFrustrations)
		assertThat(service.validFrustrationsExistFor(page), is(true))
		mocker.mockTimeToCsMappingService(serviceUnderTest, mappings, [100, 200])
		assertThat(service.validFrustrationsExistFor(page), is(true))
		
		//without frustrations for page		
		mocker.mockTimeToCsMappingService(serviceUnderTest, mappings, [])
		assertThat(service.validFrustrationsExistFor(page), is(false))
		
		//with invalid frustrations for page: just one frustration
		mocker.mockTimeToCsMappingService(serviceUnderTest, mappings, [100])
		assertThat(service.validFrustrationsExistFor(page), is(false))
		
		//with invalid frustrations for page: just one frustration
		mocker.mockTimeToCsMappingService(serviceUnderTest, mappings, [1000, 1000, 1000, 1000])
		assertThat(service.validFrustrationsExistFor(page), is(false))
		
		//with valid frustrations but null as page
		mocker.mockTimeToCsMappingService(serviceUnderTest, mappings, hpFrustrations)
		assertThat(service.validFrustrationsExistFor(null), is(false))
		
		//with valid frustrations but UNDEFINED page
		mocker.mockTimeToCsMappingService(serviceUnderTest, mappings, hpFrustrations)
		assertThat(service.validFrustrationsExistFor(new Page(name: Page.UNDEFINED, weight: 0)), is(false))
		
	}

	@Before
	void setUp(){
		
		serviceUnderTest = service
		
		// test data common for all tests
		page = new Page(
			name: 'HP')
		fvDocAndCsFromExcel =
		[
			[2073,0.976],
			[2441,0.952],
			[2340,0.958],
			[4394,0.783],
			[2693,0.938],
			[2446,0.951],
			[2469,0.951],
			[2792,0.931],
			[2127,0.969],
			[2432,0.952],
			[2116,0.97],
			[1863,0.988],
			[1971,0.983],
			[2105,0.971],
			[1777,0.99],
			[2965,0.925],
			[1833,0.988],
			[2230,0.965],
			[1991,0.982],
			[1814,0.988],
			[1874,0.988],
			[1775,0.991],
			[1891,0.987],
			[2441,0.952]
		]
		mappings =[
			'HP_0': 1,
			'HP_100': 1,
			'HP_200': 1,
			'HP_300': 1,
			'HP_400': 1,
			'HP_500': 1,
			'HP_600': 1,
			'HP_700': 1,
			'HP_800': 1,
			'HP_900': 1,
			'HP_1000': 1,
			'HP_1100': 1,
			'HP_1200': 1,
			'HP_1300': 1,
			'HP_1400': 1,
			'HP_1500': 0.998,
			'HP_1600': 0.996,
			'HP_1700': 0.993,
			'HP_1800': 0.989,
			'HP_1900': 0.987,
			'HP_2000': 0.982,
			'HP_2100': 0.972,
			'HP_2200': 0.967,
			'HP_2300': 0.959,
			'HP_2400': 0.955,
			'HP_2500': 0.95,
			'HP_2600': 0.945,
			'HP_2700': 0.937,
			'HP_2800': 0.93,
			'HP_2900': 0.926,
			'HP_3000': 0.921,
			'HP_3100': 0.91,
			'HP_3200': 0.902,
			'HP_3300': 0.894,
			'HP_3400': 0.882,
			'HP_3500': 0.875,
			'HP_3600': 0.869,
			'HP_3700': 0.856,
			'HP_3800': 0.84,
			'HP_3900': 0.835,
			'HP_4000': 0.827,
			'HP_4100': 0.817,
			'HP_4200': 0.809,
			'HP_4300': 0.793,
			'HP_4400': 0.782,
			'HP_4500': 0.775,
			'HP_4600': 0.757,
			'HP_4700': 0.746,
			'HP_4800': 0.732,
			'HP_4900': 0.723,
			'HP_5000': 0.71,
			'HP_5100': 0.698,
			'HP_5200': 0.685,
			'HP_5300': 0.674,
			'HP_5400': 0.667,
			'HP_5500': 0.657,
			'HP_5600': 0.651,
			'HP_5700': 0.644,
			'HP_5800': 0.64,
			'HP_5900': 0.627,
			'HP_6000': 0.62,
			'HP_6100': 0.612,
			'HP_6200': 0.602,
			'HP_6300': 0.591,
			'HP_6400': 0.584,
			'HP_6500': 0.572,
			'HP_6600': 0.563,
			'HP_6700': 0.552,
			'HP_6800': 0.543,
			'HP_6900': 0.534,
			'HP_7000': 0.524,
			'HP_7100': 0.519,
			'HP_7200': 0.511,
			'HP_7300': 0.505,
			'HP_7400': 0.5,
			'HP_7500': 0.493,
			'HP_7600': 0.484,
			'HP_7700': 0.477,
			'HP_7800': 0.474,
			'HP_7900': 0.468,
			'HP_8000': 0.466,
			'HP_8100': 0.457,
			'HP_8200': 0.451,
			'HP_8300': 0.443,
			'HP_8400': 0.438,
			'HP_8500': 0.432,
			'HP_8600': 0.424,
			'HP_8700': 0.418,
			'HP_8800': 0.412,
			'HP_8900': 0.405,
			'HP_9000': 0.398,
			'HP_9100': 0.39,
			'HP_9200': 0.38,
			'HP_9300': 0.371,
			'HP_9400': 0.365,
			'HP_9500': 0.358,
			'HP_9600': 0.355,
			'HP_9700': 0.35,
			'HP_9800': 0.342,
			'HP_9900': 0.334,
			'HP_10000': 0.326,
			'HP_10100': 0.321,
			'HP_10200': 0.314,
			'HP_10300': 0.307,
			'HP_10400': 0.298,
			'HP_10500': 0.293,
			'HP_10600': 0.287,
			'HP_10700': 0.283,
			'HP_10800': 0.279,
			'HP_10900': 0.275,
			'HP_11000': 0.269,
			'HP_11100': 0.262,
			'HP_11200': 0.259,
			'HP_11300': 0.257,
			'HP_11400': 0.252,
			'HP_11500': 0.249,
			'HP_11600': 0.246,
			'HP_11700': 0.237,
			'HP_11800': 0.234,
			'HP_11900': 0.229,
			'HP_12000': 0.225,
			'HP_12100': 0.218,
			'HP_12200': 0.213,
			'HP_12300': 0.21,
			'HP_12400': 0.205,
			'HP_12500': 0.203,
			'HP_12600': 0.201,
			'HP_12700': 0.199,
			'HP_12800': 0.192,
			'HP_12900': 0.189,
			'HP_13000': 0.184,
			'HP_13100': 0.178,
			'HP_13200': 0.174,
			'HP_13300': 0.169,
			'HP_13400': 0.164,
			'HP_13500': 0.161,
			'HP_13600': 0.158,
			'HP_13700': 0.155,
			'HP_13800': 0.154,
			'HP_13900': 0.151,
			'HP_14000': 0.146,
			'HP_14100': 0.142,
			'HP_14200': 0.138,
			'HP_14300': 0.136,
			'HP_14400': 0.133,
			'HP_14500': 0.132,
			'HP_14600': 0.13,
			'HP_14700': 0.128,
			'HP_14800': 0.128,
			'HP_14900': 0.126,
			'HP_15000': 0.122,
			'HP_15100': 0.119,
			'HP_15200': 0.118,
			'HP_15300': 0.116,
			'HP_15400': 0.115,
			'HP_15500': 0.111,
			'HP_15600': 0.111,
			'HP_15700': 0.109,
			'HP_15800': 0.106,
			'HP_15900': 0.102
			]
		hpFrustrations = [
			1382,1445,1478,1487,1560,1578,1622,1628,1629,1639,1684,1770,1775,1778,1787,1797,1833,1908,1908,1919,1928,1967,1968,1987,2006,2020,2026,
			2037,2047,2047,2060,2067,2075,2079,2083,2090,2092,2102,2104,2122,2128,2138,2163,2210,2218,2222,2229,2253,2274,2276,2277,2282,2291,2304,
			2340,2357,2382,2389,2390,2402,2405,2408,2414,2445,2469,2508,2525,2529,2529,2530,2531,2601,2602,2620,2624,2625,2636,2643,2648,2657,2672,
			2699,2712,2721,2727,2745,2751,2756,2770,2791,2798,2810,2832,2866,2867,2880,2946,2948,2980,2983,2988,2998,3000,3013,3022,3024,3035,3038,
			3040,3049,3058,3067,3073,3078,3080,3083,3104,3108,3121,3139,3140,3140,3144,3163,3174,3176,3204,3212,3214,3216,3236,3250,3266,3273,3273,
			3276,3281,3303,3306,3313,3321,3328,3340,3346,3348,3383,3384,3385,3388,3389,3390,3395,3403,3407,3407,3408,3417,3422,3431,3438,3481,3513,
			3516,3557,3563,3564,3589,3593,3596,3601,3603,3609,3618,3629,3630,3636,3640,3643,3656,3660,3662,3668,3670,3672,3688,3701,3703,3703,3706,
			3717,3728,3728,3732,3736,3737,3748,3749,3766,3766,3778,3778,3781,3785,3792,3796,3797,3798,3805,3824,3833,3836,3853,3854,3918,3952,3952,
			3958,3964,3964,3985,3990,3991,3992,4000,4006,4008,4018,4030,4039,4052,4055,4070,4074,4078,4096,4100,4104,4114,4139,4145,4150,4155,4167,
			4167,4172,4191,4197,4204,4209,4212,4218,4218,4222,4232,4244,4253,4258,4258,4260,4266,4266,4268,4284,4287,4288,4292,4300,4301,4304,4311,
			4315,4321,4328,4340,4343,4352,4357,4367,4384,4394,4395,4406,4407,4410,4414,4446,4473,4474,4485,4493,4504,4505,4507,4524,4527,4531,4532,
			4546,4554,4556,4559,4562,4565,4567,4572,4574,4578,4578,4582,4584,4588,4594,4596,4598,4606,4619,4625,4639,4647,4649,4657,4661,4665,4668,
			4669,4674,4696,4703,4705,4712,4716,4718,4720,4726,4737,4738,4738,4745,4750,4759,4766,4769,4769,4778,4796,4800,4814,4828,4834,4840,4845,
			4859,4865,4877,4879,4885,4890,4903,4908,4911,4917,4919,4921,4932,4946,4967,4979,4981,4984,4988,4988,4994,4997,5002,5005,5006,5013,5020,
			5023,5049,5051,5055,5062,5085,5087,5088,5093,5094,5096,5109,5110,5125,5129,5135,5140,5141,5147,5148,5169,5173,5176,5178,5179,5179,5186,
			5200,5202,5207,5207,5211,5229,5230,5232,5235,5250,5251,5258,5266,5278,5297,5304,5310,5325,5326,5338,5350,5357,5364,5390,5403,5415,5421,
			5422,5429,5443,5445,5455,5458,5479,5483,5485,5490,5516,5531,5532,5562,5567,5580,5594,5597,5610,5615,5639,5640,5666,5673,5679,5683,5731,
			5738,5750,5758,5790,5804,5807,5812,5815,5820,5821,5828,5830,5851,5853,5855,5867,5875,5881,5881,5894,5899,5901,5903,5912,5912,5921,5933,
			5953,5953,5978,6000,6004,6006,6019,6027,6043,6045,6049,6052,6084,6117,6122,6124,6131,6134,6136,6148,6148,6152,6157,6188,6188,6197,6233,
			6234,6235,6237,6238,6244,6259,6262,6263,6272,6281,6283,6295,6297,6302,6328,6328,6337,6353,6358,6366,6367,6372,6411,6411,6413,6425,6429,
			6438,6443,6456,6458,6464,6470,6474,6481,6482,6492,6499,6501,6502,6505,6519,6531,6540,6549,6570,6587,6590,6592,6604,6606,6635,6638,6645,
			6648,6650,6658,6662,6670,6677,6681,6695,6699,6700,6712,6714,6718,6724,6761,6762,6780,6782,6790,6797,6800,6803,6815,6818,6828,6830,6863,
			6875,6878,6879,6882,6887,6911,6916,6923,6943,6953,6968,6970,6973,6975,6979,6980,6985,6989,7009,7029,7040,7062,7067,7074,7099,7125,7125,
			7134,7148,7153,7156,7180,7186,7191,7192,7203,7232,7250,7253,7270,7297,7297,7302,7308,7309,7312,7320,7384,7386,7405,7422,7425,7425,7440,
			7445,7452,7481,7494,7500,7520,7522,7526,7551,7571,7575,7575,7578,7578,7579,7603,7613,7616,7625,7629,7641,7661,7662,7691,7703,7712,7728,
			7781,7784,7813,7819,7838,7858,7862,7872,7887,7950,7954,7963,8011,8026,8050,8053,8063,8065,8065,8076,8086,8088,8090,8094,8112,8157,8178,
			8185,8188,8194,8194,8212,8218,8227,8228,8244,8250,8264,8278,8287,8288,8301,8332,8338,8360,8383,8392,8395,8406,8419,8438,8443,8452,8454,
			8469,8484,8521,8524,8533,8547,8549,8563,8574,8584,8588,8589,8620,8654,8655,8660,8672,8675,8682,8708,8719,8750,8751,8763,8775,8786,8796,
			8816,8837,8844,8851,8854,8858,8864,8890,8896,8907,8912,8923,8926,8938,8940,8982,8994,9000,9025,9033,9060,9063,9064,9064,9075,9076,9079,
			9098,9101,9124,9125,9131,9141,9141,9145,9152,9182,9187,9189,9190,9195,9202,9210,9218,9228,9229,9230,9235,9235,9246,9260,9272,9273,9307,
			9321,9322,9326,9359,9385,9386,9409,9415,9442,9444,9464,9470,9478,9485,9486,9496,9531,9547,9583,9598,9604,9640,9672,9691,9695,9701,9709,
			9719,9724,9728,9730,9735,9745,9773,9782,9797,9811,9818,9819,9828,9852,9852,9859,9881,9888,9897,9900,9906,9937,9940,9953,9958,9963,9971,
			9979,9983,10010,10020,10044,10047,10054,10059,10081,10116,10141,10143,10170,10172,10178,10179,10185,10187,10230,10234,10244,10250,10252,
			10255,10275,10296,10297,10311,10311,10315,10337,10339,10343,10351,10355,10363,10366,10375,10393,10418,10433,10443,10444,10489,10499,10513,
			10519,10531,10538,10538,10577,10577,10606,10608,10626,10661,10690,10691,10740,10743,10757,10762,10762,10823,10839,10860,10875,10891,10905,
			10922,10928,10951,10953,10965,10979,10989,11019,11021,11037,11057,11060,11063,11090,11091,11104,11105,11155,11167,11199,11252,11269,11297,11324,11329,11376,11377,11391,11409,
			11415,11417,11443,11505,11508,11535,11547,11607,11608,11608,11625,11630,11655,11673,11678,11678,11687,11688,11701,11731,11744,11786,11789,11816,11840,11843,11854,11854,11857,
			11928,11949,11968,11969,11988,11998,12047,12048,12055,12060,12073,12083,12085,12090,12125,12133,12143,12151,12154,12177,12184,12237,12243,12279,12281,12311,12343,12344,12344,
			12377,12377,12417,12438,12480,12550,12586,12591,12658,12673,12709,12716,12734,12743,12756,12771,12775,12779,12789,12825,12851,12896,12907,12915,12933,12951,12973,12976,12994,
			13000,13062,13072,13089,13090,13096,13098,13100,13122,13150,13174,13175,13199,13203,13206,13265,13269,13278,13297,13302,13307,13343,13343,13391,13397,13398,13418,13466,13485,
			13500,13505,13529,13585,13601,13625,13670,13680,13711,13782,13865,13870,13891,13933,13965,13968,13980,13984,13986,14008,14024,14034,14039,14040,14127,14127,14159,14173,14183,
			14187,14213,14218,14276,14337,14358,14391,14408,14428,14571,14579,14640,14672,14687,14844,14848,14887,14933,14959,14985,14994,15009,15058,15071,15073,15187,15203,15231,15240,
			15391,15400,15441,15468,15481,15485,15502,15670,15678,15737,15753,15765,15774,15803,15804,15818,15842,15855,15891,15950,16000,16054,16098,16100,16155,16179,16214,16226,16230,
			16265,16278,16281,16397,16453,16463,16515,16516,16604,16626,16630,16632,16656,16657,16674,16712,16750,16781,16844,16864,16875,16908,16932,16941,16957,17145,17148,17178,17199,
			17206,17227,17301,17326,17375,17376,17394,17432,17448,17482,17497,17599,17605,17630,17649,17675,17727,17742,17753,17795,17796,17821,17880,17883,17966,18093,18096,18134,18195,
			18268,18271,18365,18374,18532,18572,18648,18650,18706,18716,18746,18763,18825,18828,18828,18890,18984,19016,19322,19411,19502,19519,19633,19640,19670,19672,19766,19854,19933,
			20000,20162,20170,20235,20530,20531,20683,20693,20711,21292,21325,21390,21417,21422,21427,21484,21544,21805,21947,22000,22010,22207,22516,22647,22672,22701,22833,22874,22888,
			23162,23164,23896,23922
			]
		
		// mocks common for all tests
		mocker = ServiceMocker.create()
	}

}
